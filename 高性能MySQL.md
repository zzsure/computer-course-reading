# 第1章 MySQL架构与历史

## 1.1 MySQL逻辑架构
- 最上层：连接处理、授权认证、安全等等
- 第二层：所有跨存储引擎的功能都在这一层实现：存储过程、触发器、视图等
- 第三层：存储引擎，负责MySQL中数据存取和提取

### 1.1.1 连接管理与安全性
- 每个客户端连接都会在服务器进程中拥有一个线程
- 连接到MySQL服务器后，服务器需要进行认证。然后查询是否有特定权限

### 1.1.2 优化与执行
MySQL会解析查询，并创建内部数据结构（解析树），然后对其进行各种优化，包括重写查询、决定表的读取顺序，一级选择合适的索引等

## 1.2 并发控制
无论何时，只要有多个查询需要在同一时刻修改数据，都会产生并发控制的问题

### 1.2.1 读写锁
读锁是共享的，相互不阻塞的。写锁是排他的，也就是说一个写锁会阻塞其他的写锁和读锁

### 1.2.2 锁粒度
- 一种提高共享资源并发性的方式就是让锁定对象更有选择性。尽量只锁定需要修改的部分数据，而不是所有的资源。
- 表锁：它会锁定整张表，一个用户对表进行写操作（插入、删除、更新等）前，需要先获得写锁。会阻塞其他用户对该表的所有的读写操作
- 行级锁：可以最大程度的支持并发处理（同时也带来了最大的锁开销），行级锁只在存储引擎层实现

## 1.3 事务
- 事务就是一组原子性的SQL查询，或者说一个独立的工作单元。事务内的语句，要么全部执行成功，要么全部执行失败。
- ACID表示原子性（atomicity）、一致性（consistency）、隔离性（isolation）和持久性（durability）

### 1.3.1 隔离级别
- READ UNCOMMITTED（未提交读）：事务中的修改，即使没有提交，对其他事务也都是可见的。事务可以读取未提交的数据，这也被称为脏读
- READ COMMITED（提交读）：一个事务开始时，只能”看见“已经提交的事务所做的修改。也叫不可重复读
- REPEATABLE READ（可重复读）：保证了在同一个事务中多次读取同样记录的结果是一致的。无法解决幻读（当某个事务在读取某个范围的记录时，会产生幻行）的问题
- SERIALIZABLE（可串行读）：强制事务串行执行，避免了幻读问题

### 1.3.2 死锁
- 死锁是指两个或者多个事务在同一资源上相互占用，并请求锁定对方占用资源，从而导致恶性循环的现象。
- InnoDB目前处理死锁的方法是，将持有最少行级排他锁进行回滚
- 死锁发生以后，只有部分或者完全回滚其中一个事务，才能打破死锁。

### 1.3.3 事务日志
使用事务日志，存储引擎在修改表的数据时只需要修改其内存拷贝，再把改修改行为记录到持久在硬盘的事务日志中，而不用每次都将修改的数据本身持久到磁盘。如果数据的修改已经记录到事务日志并持久化，但数据本身还没有写会磁盘，此时系统崩溃，存储引擎在重启时能够将自动恢复这部分修改的数据。

### 1.3.4 MySQL中的事务

#### 自动提交
默认方式，如果不是显示地开始一个事务，则每个查询都被当做一个事务执行提交操作。

#### 在事务中混合使用存储引擎
事务是由下层的存储引擎实现的。所以在同一个事务中，使用多种存储引擎是不可靠的。

#### 隐式和显示锁定
InnoDB采用的是两阶段锁定协议。在事务执行过程中，随时都可以执行锁定，锁只有在执行COMMIT或者ROLLBACK的时候才会释放，并且所有的锁是在同一时刻释放。前面描述的锁定都是隐式锁定，InnoDB会根据隔离级别在需要的时候自动加锁。

## 1.4 多版本并发控制
- MySQL的大多数事务型存储引擎实现的都不是简单的行级锁。基于提升并发性能的考虑，它们一般都同时实现了多版本并发控制（MVCC）
- MVCC的实现是通过保存数据在某个时间点的快照来实现的。也就说，不管需要执行多长时间，每个事务看到的数据都是一致的。
- InnoDB的MVCC，是通过再每行记录后面保存两个隐藏的列来实现的。这两个列，一个保存了行的创建时间，一个保存行的过期时间。当然存储的并不是实际的时间值，而是系统版本号。
- MVCC只在REPEATABLE READ和READ COMMITTED两个级别下工作

## 1.5 MySQL的存储引擎
可以用SHOW TABLE STATUS命令显示表的相关信息

### 1.5.1 InnoDB存储引擎
InnoDB是MySQL的默认事务型引擎

#### InnoDB的历史
InnoDB是一个很重要的存储引擎，很多个人和公司都对其贡献代码，而不仅仅是Oracle公司的开发团队。一些重要的贡献者包括Google、Yasufumi Kinoshita、Percona、Facebook等

#### InnoDB概览
- InnoDB的数据存储在表空间中，采用MVCC来支持高并发，并且实现了四个标准的隔离级别。默认级别是可重复读，并且通过间隙锁防止幻读出现，间隙锁不仅仅锁定查询涉及的行，还会对索引中的间隙进行锁定，以防止幻影行的插入。
- InnoDB使用聚簇索引，对主键查询有很高的性能，不过它的二级索引中必须包含主键列，所以如果索引比较多的话，主键应当尽可能的小
- InnoDB支持真正的热备份

### 1.5.2 MyISAM存储引擎
MyISAM不支持事务和行级锁，崩溃后无法安全恢复
